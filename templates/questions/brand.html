{% extends 'questions/base.html' %}
{% block title %}
    آگاهی برند
{% endblock %}
{% block extra_head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.4.1/chart.min.js"></script>
    <style>
        .hide {
            display: none;
        }

        .show {
            display: block;
        }
    </style>
{% endblock %}
{% block content %}
    <input type="hidden" value="{{ answersheet }}" name="answersheet">
    <input type="hidden" value="{{ last_question }}" name="last_question">
    <input type="hidden" value="{{ first_question }}" name="first_question">
    {% for question in questions %}
        <div class="questions" id="questions{{ question.pk }}">
            <h4>{{ question }}</h4>
        </div>
    {% endfor %}
            <div class="options" id="options">

        </div>
    <button type="button" id="previous_btn" class="btn btn-primary btn-lg">قبل</button>
    <button type="button" id="next_btn" class="btn btn-primary btn-lg">بعد</button>
    <form method="post">
        {% csrf_token %}
        <button type="submit" class="hide btn btn-primary btn-lg" id="submit">ادامه</button>
    </form>
{% endblock %}
{% block js %}
    <script>
            $(document).ready(function () {
                get_brands()
            });

        function get_brands() {
            $.ajax({
                url: '{% url 'Survey:brand_list_ajax' %}',
                dataType: "json",
                success: function (response) {
                    localStorage.setItem('brands', JSON.stringify(response))
                }
            });
        }

        $(document).ajaxSuccess(function () {
            go_to_next_or_previous_question('next')
            refresh_page('next')
            $('#previous_btn').addClass('hide')
        })
        $('#next_btn').click(function () {
            $('#previous_btn').removeClass('hide')
            let current_question_id = $('input[name=first_question]').val()
            let last_question = $('input[name=last_question]').val()
            //چک میکنم که به سوال آخر رسیدم submit کنم
            if (parseInt(current_question_id) > parseInt(last_question)) {
                $('#next_btn').addClass('hide')
                $('#submit').removeClass('hide')
            }
            //checkbox های تیک خورده را پیدا میکنم
            let answer = document.querySelectorAll('input:checked')
            if (answer.length == 0) {
                answer = document.querySelectorAll('input[type=text]')
            }
            //بخش گزینه های سوال قبلی را پاک میکنم
            $('#options').html('')
            // به سوال بعدی بروم
            go_to_next_or_previous_question('next', answer)
            //صفحه را refresh به بعد میکنم
            refresh_page('next')
        });

        $('#previous_btn').click(function () {
            let current_question_id = $('input[name=first_question]').val()
            //بخش گزینه های سوال قبلی را پاک میکنم
            $('#options').html('')
            //صفحه را refresh به قبل میکنم
            refresh_page('previous')
            // به سوال قبل بروم
            go_to_next_or_previous_question('previous')
        });

        function get_data(data) {
            return JSON.parse(localStorage.getItem(data))
        }

        function go_to_next_or_previous_question(next_or_previous, answer = undefined) {
            let current_question_id = $('input[name=first_question]').val()

            if ((current_question_id) == 8) {
                //question8
                if (next_or_previous == 'previous') {
                    get_brands()
                }
                let brands = JSON.parse(localStorage.brands).brands
                show_options(brands, 'brands')
                let radiobuttnons = $('input[type=checkbox]')
                radiobuttnons.on('change', function (e) {
                    if ($('input[type=checkbox]:checked').length > 1) {
                        $(this).prop('checked', false);
                        alert('لطفا حداکثر یک برند را انتخاب کنید')
                    }
                });
            }
            else if ((current_question_id) == 9) {
                //question9
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A1')
                } else {
                    temp = get_data('A1')
                }
                let brands = JSON.parse(localStorage.brands).brands
                if (answer != 99) {
                    let index
                    for (var key in temp) {
                        index = temp[key]
                    }
                    if (index != undefined) {
                        let temp1 = brands.splice(0, index - 1)
                        let temp2 = brands.splice(1, brands.length)
                        brands = temp1.concat(temp2)
                        localStorage.removeItem('brands')
                        localStorage.setItem('brands', JSON.stringify(brands))
                    }
                }
                show_options(brands, 'brands')
            }
            else if ((current_question_id) == 10) {
                //question10
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A2')
                    let A1 = JSON.parse(localStorage.A1)
                    $.extend(temp, A1)
                } else {
                    temp = get_data('A2')
                }
                show_options(temp, 'rest')
            }
            else if ((current_question_id) == 11) {
                //question11
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A4')
                } else {
                    temp = get_data('A4')
                }
                show_options(temp, 'rest')
                let radiobuttnons = $('input[type=checkbox]')
                radiobuttnons.on('change', function (e) {
                    if ($('input[type=checkbox]:checked').length > 3) {
                        $(this).prop('checked', false);
                        alert('لطفا فقط 3 برند را انتخاب کنید')
                    }
                });
            }
            else if ((current_question_id) == 12) {
                //question12
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A6')
                } else {
                    temp = get_data('A6')
                }
                show_options(temp, 'text')
            }
            else if ((current_question_id) == 13) {
                //question13
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A7')
                } else {
                    temp = get_data('A7')
                }
                let chart_data = []
                let char_value = []
                let sum = 0
                for (item in temp) {
                    chart_data.push(item)
                    sum += parseInt(temp[item])
                }
                for (item in temp) {
                    char_value.push(parseInt(temp[item]) / sum * 100)
                }
                let result = '<div class="row"><div class="col-lg-2 col-md-2 col-sm-12 col-12"></div><div class="col-lg-8 col-md-8 col-sm-12 col-12"><canvas id="myChart" width="400" height="400"></canvas></div></div>'
                $('#options').html(result)
                var ctx = document.getElementById('myChart').getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chart_data,
                        datasets: [{
                            label: chart_data,
                            data: char_value,
                            backgroundColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                            ],
                            borderWidth: 1
                        }]
                    },
                });
            }
            else if ((current_question_id) == 14) {
                //question14
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A8')
                } else {
                    temp = get_data('A8')
                }
            }
            else if ((current_question_id) == 15) {
                //question15
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A9')
                } else {
                    temp = get_data('A9')
                }
            }
            else if ((current_question_id) == 16) {
                //question16
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A10')
                } else {
                    temp = get_data('A10')
                }
            }
            else if ((current_question_id) == 17) {
                //question17
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A11')
                } else {
                    temp = get_data('A11')
                }
            }
            else if ((current_question_id) == 18) {
                //question18
                let temp
                if (next_or_previous == 'next') {
                    temp = save_answer(answer, 'A12')
                } else {
                    temp = get_data('A12')
                }
            }
        }

        function refresh_page(next_or_previous) {
            let current_question_id = $('input[name=first_question]').val()
            let current_question = $('#questions' + current_question_id)
            let questions = $('.questions')
            let temp;
            if (next_or_previous == 'next') {
                temp = parseInt(current_question_id) + 1
                questions.addClass('hide')
                current_question.removeClass('hide')
            } else if (next_or_previous == 'previous') {
                    temp = parseInt(current_question_id) - 1
                current_question.removeClass('hide')
            }
            if (temp == 8) {
                $('#previous_btn').addClass('hide')
            }
            $('input[name=first_question]').val(temp)
        }

        function show_options(data, type) {
            let result = ''
            if (type == 'brands') {
                for (var i = 0; i < data.length; i++) {
                    result += '<div class="row"><label><input type="checkbox" name="' + data[i].title + '" value="' + data[i].pk + '">&nbsp' + data[i].title + '</label></div>'
                }
            } else if (type == 'rest') {
                for (item in data) {
                    result += '<div class="row"><label><input type="checkbox" name="' + item + '" value="' + data[item] + '">&nbsp' + item + '</label></div>'
                }
            } else if (type == 'text') {
                for (item in data) {
                    result += '<div class="row">' + item + ': <label><input type="text" name="' + item + '" value=""></label></div>'
                }
            }
            $('#options').html(result)
        }

        function save_answer(answer, where) {
            let temp = {};
            for (var i = 0; i < answer.length; i++) {
                if (answer[i].value != 99) {
                    temp[answer[i].name] = answer[i].value
                }
            }
            localStorage.setItem(where, JSON.stringify(temp))
            return temp
        }
    </script>
{% endblock %}