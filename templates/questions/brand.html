{% extends 'questions/base.html' %}
{% block title %}
    آگاهی برند
{% endblock %}
{% block extra_head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.4.1/chart.min.js"></script>
    <style>
    </style>
{% endblock %}
{% block content %}
    <input type="hidden" value="{{ answersheet }}" name="answersheet">
    <input type="hidden" value="{{ last_question }}" name="last_question">
    <input type="hidden" value="{{ first_question }}" name="first_question">
    <h4>
        <div class="questions" id="questions">
        </div>
    </h4>
    <br>
    <div class="options" id="options">
    </div>
    <br>
    <button type="button" id="previous_btn" class="hide btn btn-primary btn-lg">قبل</button>
    <button type="button" id="next_btn" class="btn btn-primary btn-lg">بعد</button>
    <form method="post">
        {% csrf_token %}
        <button type="submit" class="hide btn btn-primary btn-lg" id="submit">ادامه</button>
    </form>
{% endblock %}
{% block js %}
    <script>
        let current_direction
        let next_btn = $('#next_btn')
        let previous_btn = $('#previous_btn')
        let options_html = $('#options')
        let questions_html = $('#questions')
        let current_question = parseInt($('input[name=first_question]').val())
        let first_question = parseInt($('input[name=first_question]').val())
        let last_question = parseInt($('input[name=last_question]').val())
        let submit_btn = $('#submit')
        $(document).ready(function () {
            fetch_data_from_server()
        });

        function fetch_data_from_server() {
            $.ajax({
                url: '{% url 'Survey:brand_list_ajax' %}',
                dataType: "json",
                success: function (response) {
                    localStorage.setItem('brands', JSON.stringify(response))
                }
            });
            let data = {'first_question': first_question}
            $.ajax({
                url: '{% url 'Survey:question_list_ajax' %}',
                dataType: "json",
                data: data,
                success: function (response) {
                    localStorage.setItem('questions', JSON.stringify(response))
                }
            });
        }

        $(document).ajaxSuccess(function () {
            question_management('next')
            paging('next')
            previous_btn.addClass('hide')
        })
        next_btn.click(function () {
            //چک میکنم که به سوال آخر رسیدم submit کنم
            if (current_question > last_question) {
                next_btn.addClass('hide')
                submit_btn.removeClass('hide')
            }
            //checkbox های تیک خورده را پیدا میکنم
            let answer = document.querySelectorAll('input:checked')
            if (answer.length == 0) {
                answer = document.querySelectorAll('input[type=number]')
            }
            if (answer.length == 0) {
                answer = $('select')
            }


            //بخش گزینه های سوال قبلی را پاک میکنم
            options_html.fadeOut(2).html('')
            questions_html.fadeOut(2).html('')
            next_btn.fadeOut(2)
            previous_btn.fadeOut(2)
            if (current_direction == 'previous') {
                //صفحه را refresh به بعد میکنم
                paging('next')
            }
            // به سوال بعدی بروم
            question_management('next', answer)
            //صفحه را refresh به بعد میکنم
            paging('next')
        });

        previous_btn.click(function () {
            //بخش گزینه های سوال قبلی را پاک میکنم
            options_html.fadeOut(2).html('')
            questions_html.fadeOut(2).html('')
            next_btn.fadeOut(2)
            previous_btn.fadeOut(2)
            //صفحه را refresh به قبل میکنم
            paging('previous')
            // به سوال قبل بروم
            question_management('previous')
        });

        function get_data_localstorage(data) {
            return JSON.parse(localStorage.getItem(data))
        }

        function question_management(next_or_previous, answer = undefined) {

            if (current_question == 8) {
                //question8
                if (next_or_previous == 'previous') {
                    fetch_data_from_server()
                }
                let brands = JSON.parse(localStorage.brands).brands
                options_show(brands, 'brands')
                let radiobuttnons = $('input[type=checkbox]')
                radiobuttnons.on('change', function (e) {
                    if ($('input[type=checkbox]:checked').length > 1) {
                        $(this).prop('checked', false);
                        alert('لطفا فقط یک برند را انتخاب کنید')
                    }
                });
            } else if (current_question == 9) {
                //question9
                let temp
                if (next_or_previous == 'next') {
                    temp = set_data_localstorage(answer, 'A1')
                } else {
                    temp = get_data_localstorage('A1')
                }
                let brands = JSON.parse(localStorage.brands).brands
                if (answer != 99) {
                    let index
                    for (var key in temp) {
                        index = temp[key]
                    }
                    if (index != undefined) {
                        let temp1 = brands.splice(0, index - 1)
                        let temp2 = brands.splice(1, brands.length)
                        brands = temp1.concat(temp2)
                        localStorage.removeItem('brands')
                        localStorage.setItem('brands', JSON.stringify(brands))
                    }
                }
                options_show(brands, 'brands')
            } else if (current_question == 10) {
                //question10
                let temp
                if (next_or_previous == 'next') {
                    temp = set_data_localstorage(answer, 'A2')
                    let A1 = JSON.parse(localStorage.A1)
                    $.extend(temp, A1)
                } else {
                    temp = get_data_localstorage('A2')
                }
                options_show(temp, 'rest')
            } else if (current_question == 11) {
                //question11
                let temp
                if (next_or_previous == 'next') {
                    temp = set_data_localstorage(answer, 'A4')
                } else {
                    temp = get_data_localstorage('A4')
                }
                options_show(temp, 'rest')
                let radiobuttnons = $('input[type=checkbox]')
                radiobuttnons.on('change', function (e) {
                    if ($('input[type=checkbox]:checked').length > 3) {
                        $(this).prop('checked', false);
                        alert('لطفا حداکثر سه برند را انتخاب کنید')
                    }
                });
            } else if (current_question == 12) {
                //question12
                let temp
                if (next_or_previous == 'next') {
                    temp = set_data_localstorage(answer, 'A6')
                } else {
                    temp = get_data_localstorage('A6')
                }
                options_show(temp, 'number')
                $('.option').change(function () {
                    var min = parseInt($(this).attr('min'));
                    if ($(this).val() < min) {
                        $(this).val(min);
                    }
                });
            } else if (current_question == 13) {
                //question13
                previous_btn.removeClass('hide')
                let temp
                if (next_or_previous == 'next') {
                    temp = set_data_localstorage(answer, 'A7')
                } else {
                    temp = get_data_localstorage('A7')
                }
                let chart_data = []
                let char_value = []
                let sum = 0
                for (item in temp) {
                    chart_data.push(item)
                    sum += parseInt(temp[item])
                }
                for (item in temp) {
                    char_value.push(parseInt(temp[item]) / sum * 100)
                }
                let result = '<div class="row"><div class="col-lg-2 col-md-2 col-sm-12 col-12"></div><div class="col-lg-8 col-md-8 col-sm-12 col-12"><canvas id="myChart" width="400" height="400"></canvas></div></div>'
                options_html.fadeIn(400).html(result)
                next_btn.fadeIn(400)
                previous_btn.fadeIn(400)
                questions_show()
                var ctx = document.getElementById('myChart').getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chart_data,
                        datasets: [{
                            label: chart_data,
                            data: char_value,
                            backgroundColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                            ],
                            borderWidth: 1
                        }]
                    },
                });
            } else if (current_question == 14) {
                //question14
                //چیزی ذخیره نمیشود
                previous_btn.addClass('hide')
                options_show(JSON.parse(localStorage.A7), 'numberWithLimit')
                $('.option').change(function () {
                    var max = parseInt($(this).attr('max'));
                    var min = parseInt($(this).attr('min'));
                    if ($(this).val() > max) {
                        $(this).val(max);
                    } else if ($(this).val() < min) {
                        $(this).val(min);
                    }
                });
            } else if (current_question == 15) {
                //question15
                let temp
                if (next_or_previous == 'next') {
                    temp = set_data_localstorage(answer, 'A9')
                } else {
                    temp = get_data_localstorage('A9')
                }
                options_show(JSON.parse(localStorage.A9), 'currency')
            } else if (current_question == 16) {
                //question16
                let temp
                if (next_or_previous == 'next') {
                    temp = set_data_localstorage(answer, 'A10')
                } else {
                    temp = get_data_localstorage('A10')
                }
                options_show(JSON.parse(localStorage.A6), 'option')
                let error_message = $('.error')
                $('select').change(function () {
                        let selects = $('select')
                        let val1 = parseInt(selects[0].value)
                        let val2 = parseInt(selects[1].value)
                        let val3 = parseInt(selects[2].value)
                        if (val1 == val2 || val1 == val3 || val2 == val3) {
                            //تکراری هست
                            if (error_message.hasClass('hide')) {
                                //اگر خطا مخفی هست روشن کن
                                error_message.removeClass('hide')
                            }
                            if (!next_btn.hasClass('hide')) {
                                // اگر دکمه بعدی فعال هست غیر فعال کن
                                next_btn.addClass('hide')
                            }
                        } else {
                            //تکراری نیست
                            if (!error_message.hasClass('hide')) {
                                //اگر خطا فعال هست غیر فعال کن
                                error_message.addClass('hide')
                            }
                            if (next_btn.hasClass('hide')) {
                                //اگر دکمه بعدی غیر فعال هست فعال کن
                                next_btn.removeClass('hide')
                            }
                        }
                    }
                );
            } else if (current_question == 17) {
                //question17
                let temp
                if (next_or_previous == 'next') {
                    temp = set_data_localstorage(answer, 'A11')
                } else {
                    temp = get_data_localstorage('A11')
                }
                options_show(JSON.parse(localStorage.A4), 'radioButton')
            } else if (current_question == 18) {
                //question18
                let temp
                if (next_or_previous == 'next') {
                    temp = set_data_localstorage(answer, 'A12')
                } else {
                    temp = get_data_localstorage('A12')
                }
            }
            questions_show()
        }

        function paging(next_or_previous) {
            let temp;
            if (next_or_previous == 'next') {
                temp = current_question + 1
                current_direction = 'next'
            } else if (next_or_previous == 'previous') {
                if (current_direction == 'next') {
                    temp = current_question - 2
                } else {
                    temp = current_question - 1
                }
                current_direction = 'previous'
            }
            if (temp == 8) {
                previous_btn.addClass('hide')
            }
            current_question = temp
        }

        function options_show(data, type) {
            let result = ''
            let counter = 0
            if (type == 'brands') {
                for (var i = 0; i < data.length; i++) {
                    result += '<div class="form-check">' +
                        '<label class="form-check-label" for="flexCheckDefault">' + data[i].title + '' +
                        '<input class="form-check-input" type="checkbox" value="' + data[i].pk + '" name="' + data[i].title + '" id="flexCheckDefault">' +
                        '</label>' +
                        '</div>'
                }
            } else if (type == 'rest') {
                for (item in data) {
                    result += '<div class="form-check">' +
                        '<label class="form-check-label" for="flexCheckDefault">' + item + '' +
                        '<input class="form-check-input" type="checkbox" value="' + data[item] + '" name="' + item + '" id="flexCheckDefault">' +
                        '</label>' +
                        '</div>'
                }
            } else if (type == 'number') {
                for (item in data) {
                    result += '<div class="row">' +
                        '<label>' + item + ': ' +
                        '<input type="number" name="' + item + '" min="0" class="option form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">' +
                        '</label>' +
                        '</div>'
                }
            } else if (type == 'numberWithLimit') {
                for (item in data) {
                    result += '<div class="row">' +
                        '<label>' + item + ': ' +
                        '<input min="0" max="' + data[item] + '" type="number" name="' + item + '" class="option form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">' +
                        '</label>' +
                        '</div>'
                }
            } else if (type == 'currency') {
                for (item in data) {
                    result += '<div class="row">' +
                        '<label>' + item + ': ' +
                        '<input placeholder="تومان" type="number" name="' + item + '" min="0" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">' +
                        '</label>' +
                        '</div>'
                }
            } else if (type == 'option') {
                result += '<h3 class="error hide">لطفا مقادیر متفاوتی را انتخاب نمایید</h3>'
                for (item in data) {
                    result += '<div class="row">' +
                        '<label>' + item + ': ' +
                        '<select name="' + item + '" class="form-select">' +
                        '<option value="1">اول</option>' +
                        '<option value="2">دوم</option>' +
                        '<option value="3">سوم</option>' +
                        '</select></label></div>'
                }
            } else if (type == 'radioButton') {
                for (item in data) {
                    result += '<h4>' + item + '</h4>'
                    result +=
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault1">روزی یکبار یا بیشتر</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault1" value="1">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault2">چهار الی پنج مرتبه در هفته</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault2" value="2">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault3">دو الی سه مرتبه در هفته</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault3" value="3">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault4">یک مرتبه در هفته</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault4" value="4">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault5">دو هفته یک مرتبه</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault5" value="5">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault6">ماهی یک مرتبه</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault6" value="6">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault7">هر دو الی سه ماه یک مرتبه</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault7" value="7">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault8">هر چهار الی شش ماه یک مرتبه</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault8" value="8">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault9">کمتر</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault9" value="9">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault10">هیچوقت</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault10" value="10">' +
                        ' </div>' +
                        '<div class="form-check form-check-inline">' +
                        '<label class="form-check-label" for="flexRadioDefault11">نمی دانم/نمی توانم بگویم</label>' +
                        '<input class="form-check-input" type="radio" name="' + item + '" id="flexRadioDefault11" value="11">' +
                        ' </div></div>'
                }
            }
            options_html.fadeIn(400).html(result)
            next_btn.fadeIn(400)
        }

        function questions_show() {
            let question = JSON.parse(localStorage.questions)
            let question_title
            for (q in question.questions) {
                if (question.questions[q].pk == current_question) {
                    question_title = question.questions[q].question_title
                }
            }
            questions_html.fadeIn(400).html(question_title)
        }

        function set_data_localstorage(answer, where) {
            let temp = {};
            for (var i = 0; i < answer.length; i++) {
                if (answer[i].value != 99) {
                    temp[answer[i].name] = answer[i].value
                }
            }
            localStorage.setItem(where, JSON.stringify(temp))
            return temp
        }
    </script>
{% endblock %}